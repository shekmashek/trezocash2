/*
          # Setup Tax Module
          Creates tables and types for the customizable tax management module.

          ## Query Description: This operation creates a new ENUM type `tax_base_type` and a `tax_configs` table to store user-defined tax configurations. This is a non-destructive change and is required for the new tax management feature.
          
          ## Metadata:
          - Schema-Category: "Structural"
          - Impact-Level: "Low"
          - Requires-Backup: false
          - Reversible: true
          
          ## Structure Details:
          - Type Created: `tax_base_type`
          - Table Created: `tax_configs`
          
          ## Security Implications:
          - RLS Status: RLS is enabled on the new table.
          - Policy Changes: Yes, new policies are created for `tax_configs`.
          - Auth Requirements: Users can only manage their own tax configurations.
          
          ## Performance Impact:
          - Indexes: Primary key index created on `tax_configs`.
          - Triggers: None
          - Estimated Impact: Negligible.
          */

-- Drop existing objects if they exist to ensure a clean slate
DROP TABLE IF EXISTS public.tax_configs;
DROP TYPE IF EXISTS public.tax_base_type;
DROP TYPE IF EXISTS public.tax_declaration_periodicity;


-- Create ENUM types for tax configuration
CREATE TYPE public.tax_base_type AS ENUM ('revenue', 'profit', 'salary');
CREATE TYPE public.tax_declaration_periodicity AS ENUM ('monthly', 'quarterly', 'annually');

-- Create tax_configs table
CREATE TABLE public.tax_configs (
    id uuid NOT NULL DEFAULT uuid_generate_v4(),
    user_id uuid NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
    name text NOT NULL,
    rate numeric NOT NULL DEFAULT 0,
    base_type public.tax_base_type NOT NULL,
    declaration_periodicity public.tax_declaration_periodicity NOT NULL,
    payment_delay_months integer NOT NULL DEFAULT 1,
    created_at timestamp with time zone NOT NULL DEFAULT now(),
    updated_at timestamp with time zone NOT NULL DEFAULT now(),
    CONSTRAINT tax_configs_pkey PRIMARY KEY (id)
);

-- Enable RLS
ALTER TABLE public.tax_configs ENABLE ROW LEVEL SECURITY;

-- Policies for tax_configs
CREATE POLICY "Allow users to manage their own tax configs"
ON public.tax_configs
FOR ALL
USING (auth.uid() = user_id)
WITH CHECK (auth.uid() = user_id);
